<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PubMed xml to table bias</title>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script>
//http://www.alexhadik.com/blog/2014/6/12/create-pubmed-citations-automatically-using-pubmed-api
//http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=25164756&retmode=json
//http://api.jquery.com/jquery.getjson/
///Not used:
//http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2904758/
var citation_bias = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?><included>\n<!-- start of a new study -->\n<study>\n";
var citation_pico = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?><included>\n<!-- start of a new study -->\n<study>\n";
var citation_data = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?><included>\n<!-- start of a new study -->\n<study>\n";

$(document).ready(function(){
    $("#submitbutton").on("click", function(){
        //disable the button to prevent multiple clicks
		$("#submitbutton").prop( "disabled", true );
		citation_data = ""
		$("#status").html("<i>searching...</i>")
		
		//Get list of IDs based on search terms
		$.getJSON('http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json',{ 
			term : $("#input").val(),
			format: "json"
			})
		.done(function(data){
			var ids = data.esearchresult.idlist;
			var publications = [];
			iterateJSON(ids, publications);
			$("#submitbutton").prop( "disabled", false );
		});	

	});
})

function iterateJSON(idlist, publications) {
    var id = idlist.pop();
    // test with http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=11850928,11482001&format=json
    $.getJSON('http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id='+id+'&retmode=json', 
		function(summary){

        var citation = "&lt;!-- start of a new study --&gt;<br>";

        //for(author in summary.result[id].authors){
        //    citation+=summary.result[id].authors[author].name+', ';
        //}
        //citation+=' \"'+summary.result[id].title+'\" <i>'+summary.result[id].fulljournalname+'</i> '+summary.result[id].volume+'.'+summary.result[id].issue+' ('+summary.result[id].pubdate+'): '+summary.result[id].pages+'.';
  
		var studyname = summary.result[id].authors[0].name
		studyname = studyname.substring(0, studyname.indexOf(" "));

		var pubyear = summary.result[id].pubdate
		if (pubyear.indexOf(" ") > 1){
			pubyear = pubyear.substring(0, pubyear.indexOf(" "));
			}

        citation+="<span style='color:red;font-weight:bold'>&lt;citation pmid=\"" + summary.result[id].uid + '\" year=\"' + pubyear + '\" journal_abbrev=\"' + summary.result[id].source + '\"&gt;' + studyname + "&lt;/citation&gt;</span><br>"
		citation+= "&lt;randomization&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/randomization&gt;<br>"
		citation+= "&lt;allocation&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/allocation&gt;<br>"
		citation+= "&lt;blinding_people&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/blinding_people&gt;<br>"
		citation+= "&lt;blinding_assessment&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/blinding_assessment&gt;<br>"
		citation+= "&lt;attrition&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/attrition&gt;\<br>"
		citation+= "&lt;selective_reporting&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/selective_reporting&gt;<br>"
		citation+= "&lt;other_biases&gt;<span style='background-color:yellow'>&nbsp;risk</span>&lt;/other_biases&gt;<br>"
		citation+= "&lt;/study&gt;<br>"
		
        //console.log(citation);
        publications.push(citation);
        
        if(idlist.length!=0){
            iterateJSON(idlist, publications);
        }else{
            //console.log(publications);
			$("#bias").html(publications)
        }
    });
}
</script>
<style>

.wrapper
{
  width: 860px;
  margin-top: 0px;
  margin-right: auto;
  margin-bottom: 0px;
  margin-left: auto;
}
</style>
</head>
<body>
<div class="wrapper">
<input id="input" type="text" autocomplete="on" size="100" placeholder="Enter search terms or a list of PMIDs separated by spaces, commas, or semi-colons"><br/>
<button id="submitbutton" type="button">Submit</button>
<div>&nbsp;</div>
<div id="status">Waiting for click</div>
<div>Below will be the contents for file that holds the data for the meta-analysis. Replace text that is highlighted in yellow.</div>
<div>&nbsp;</div>
<div id="data" rows="50" cols="200" style="border-style: solid; border-width: 2px;width:800px">Under development</div>
<div>&nbsp;</div>
<div>Below will be the contents for file that holds the risk of bias information. Replace text that is highlighted in yellow.</div>
<div>&nbsp;</div>
<div id="bias" rows="50" cols="200" style="border-style: solid; border-width: 2px;width:800px">Contents will appear here</div>
<div>&nbsp;</div>
<div>Below will be the contents for file that holds the PICO information. Replace text that is highlighted in yellow.</div>
<div>&nbsp;</div>
<div id="pico" rows="50" cols="200" style="border-style: solid; border-width: 2px;width:800px">Under development</div>

<script>
//For gh-pages
//Page history and edit
var pagename = location.pathname.split('/').slice(-1);
if (pagename.toString().length < 1){pagename = "index.html"}
document.write("<div style='text-align:center'><a href='https://github.com/openMetaAnalysis/openMetaAnalysis.github.io/blob/master/" + pagename + "'>Edit this page</a> - <a href='https://github.com/openMetaAnalysis/openMetaAnalysis.github.io/commits/master/" + pagename + "'>Page history</a></div>")
</script>

</div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-56740469-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>
</body>
</html>
